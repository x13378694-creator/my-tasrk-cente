<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>指挥部 v4.5 | 云同步版</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #0D0D0D; color: #F3F4F6; height: 100vh; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .bento-card { background: #1A1A1A; border: 1px solid #2D2D2D; transition: all 0.2s ease; }
        .progress-bar { transition: width 0.5s ease; }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="flex flex-col">
    <nav class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#0D0D0D]/80 backdrop-blur-md z-50">
        <div class="flex items-center gap-3">
            <h1 class="text-xs font-black tracking-widest text-purple-500">CLOUD_COMMANDER</h1>
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
        </div>
        <div class="flex gap-3 items-center">
            <input id="sync-code-input" type="password" placeholder="设置同步密钥" class="bg-black text-[10px] border border-gray-800 rounded px-2 py-1 w-28 focus:border-purple-500 outline-none">
            <button onclick="syncData()" class="text-[10px] bg-purple-600/20 text-purple-400 border border-purple-500/30 px-3 py-1 rounded hover:bg-purple-600/40 transition-all">同步</button>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row p-2 gap-2 overflow-hidden">
        <section class="w-full md:w-1/3 bento-card rounded-xl p-3 flex flex-col overflow-hidden shadow-2xl">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tighter">Mission Sequence</span>
                <button onclick="addTask()" class="text-purple-500 hover:scale-110 transition-transform"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
            </div>
            <div id="list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
        </section>

        <section class="flex-1 bento-card rounded-xl p-5 flex flex-col gap-4 overflow-hidden shadow-2xl">
            <div class="flex justify-between items-start">
                <div class="space-y-1">
                    <h2 id="title" class="text-xl font-bold tracking-tight italic text-white">等待指令...</h2>
                    <input type="time" id="time-input" onchange="updateTime()" class="bg-purple-900/20 border border-purple-500/30 text-purple-400 text-[10px] rounded px-2 py-1 outline-none">
                </div>
                <div id="prog-text" class="text-3xl font-black text-purple-500 opacity-30">0%</div>
            </div>
            
            <div class="w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="bar" class="h-full bg-purple-500 progress-bar shadow-[0_0_10px_#8B5CF6]" style="width:0%"></div>
            </div>

            <div id="subs" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
            
            <div class="flex gap-2">
                <input id="sub-in" placeholder="输入下一步作战方案..." class="flex-1 bg-white/5 border border-gray-800 rounded-xl px-4 py-3 text-sm focus:border-purple-500 outline-none transition-all">
                <button onclick="addSub()" class="bg-purple-600 hover:bg-purple-700 px-6 rounded-xl text-sm font-bold active:scale-95 transition-all">添加</button>
            </div>
            
            <div class="mt-2 pt-4 border-t border-gray-800 h-1/3 flex flex-col overflow-hidden">
                <div class="flex justify-between text-[10px] mb-2 font-bold text-gray-500 uppercase tracking-widest">
                    SOP Laboratory
                    <button onclick="editSop()" id="edit-btn" class="text-purple-400 hover:underline">编辑</button>
                </div>
                <div id="sop-view" class="flex-1 overflow-y-auto prose prose-invert prose-xs text-gray-400 leading-relaxed"></div>
                <textarea id="sop-edit" class="hidden flex-1 bg-black/50 text-xs p-4 rounded-xl border border-gray-800 font-mono text-purple-300 outline-none"></textarea>
            </div>
        </section>
    </main>

    <script>
        // --- 云端核心配置 ---
        const SUPABASE_URL = 'https://ylbwdthefpcrocmvccpy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsYndkdGhlZnBjcm9jbXZjY3B5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3OTk4MDksImV4cCI6MjA4NTM3NTgwOX0.f6_5e1UpdLmZHc2aTwQJMDPTNJxb1ZQqs2OBxCklZJ4';
        const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);

        let tasks = JSON.parse(localStorage.getItem('cmd_cloud_v1')) || [];
        let cur = null;

        async function init() { 
            lucide.createIcons(); 
            renderList();
            const savedCode = localStorage.getItem('user_sync_code');
            if(savedCode) {
                document.getElementById('sync-code-input').value = savedCode;
                await pull(); // 初始拉取
            }
        }

        // 云端拉取
        async function pull() {
            const code = document.getElementById('sync-code-input').value;
            if(!code) return;
            const { data, error } = await supabase.from('tasks_sync').select('data').eq('sync_code', code).maybeSingle();
            if(data && data.data) {
                tasks = data.data;
                saveLocally();
                renderList();
                if(cur) sel(cur);
                markSuccess();
            }
        }

        // 云端推送
        async function push() {
            const code = document.getElementById('sync-code-input').value;
            if(!code) { alert("请先设置同步密钥！"); return; }
            localStorage.setItem('user_sync_code', code);
            const { error } = await supabase.from('tasks_sync').upsert({ id: code, sync_code: code, data: tasks });
            if(!error) markSuccess();
        }

        function markSuccess() {
            const dot = document.getElementById('sync-dot');
            dot.className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22C55E]';
            setTimeout(() => { dot.classList.remove('shadow-[0_0_8px_#22C55E]'); }, 2000);
        }

        function saveLocally() { localStorage.setItem('cmd_cloud_v1', JSON.stringify(tasks)); }
        async function syncData() { await push(); await pull(); }

        // --- 业务逻辑 ---
        function addTask() {
            let t = prompt("设定作战目标:");
            if(!t) return;
            tasks.unshift({id:Date.now(), t, subs:[], time:"", sop:"", done:false});
            saveAndSync(); renderList(); sel(tasks[0].id);
        }

        function renderList() {
            document.getElementById('list').innerHTML = tasks.map(x => `
                <div onclick="sel(${x.id})" class="p-3 rounded-xl cursor-pointer border transition-all ${cur===x.id?'border-purple-500 bg-purple-500/10 shadow-lg shadow-purple-500/5':'border-gray-800 hover:border-gray-600'}">
                    <div class="flex justify-between text-[10px] mb-2 font-bold uppercase">
                        <span class="${prog(x)===100?'text-green-500':'text-gray-300'}">${x.t}</span>
                        <span class="text-purple-500 font-mono">${prog(x)}%</span>
                    </div>
                    <div class="w-full h-[2px] bg-gray-800 rounded-full overflow-hidden">
                        <div class="bg-purple-500 h-full transition-all duration-500" style="width:${prog(x)}%"></div>
                    </div>
                </div>`).join('');
        }

        function sel(id) {
            cur = id; let x = tasks.find(v => v.id === id);
            document.getElementById('title').innerText = x.t;
            document.getElementById('time-input').value = x.time;
            document.getElementById('prog-text').innerText = prog(x) + '%';
            renderSubs();
            document.getElementById('sop-view').innerHTML = marked.parse(x.sop || "_暂无 SOP，点击编辑开始录入指令。_");
            renderList();
        }

        function addSub() {
            let i = document.getElementById('sub-in');
            if(!i.value || !cur) return;
            tasks.find(x => x.id === cur).subs.push({id:Date.now(), d:i.value, ok:false});
            i.value = ""; saveAndSync(); renderSubs(); renderList();
        }

        function toggle(sid) {
            let s = tasks.find(x => x.id === cur).subs.find(v => v.id === sid);
            s.ok = !s.ok; saveAndSync(); renderSubs(); renderList();
        }

        function renderSubs() {
            let x = tasks.find(v => v.id === cur);
            document.getElementById('bar').style.width = prog(x) + '%';
            document.getElementById('prog-text').innerText = prog(x) + '%';
            document.getElementById('subs').innerHTML = x.subs.map(s => `
                <div class="flex items-center gap-3 bg-white/[0.03] p-3 rounded-xl hover:bg-white/[0.06] transition-colors">
                    <input type="checkbox" ${s.ok?'checked':''} onchange="toggle(${s.id})" class="w-4 h-4 rounded accent-purple-500">
                    <span class="text-sm ${s.ok?'line-through text-gray-600':'text-gray-200'}">${s.d}</span>
                </div>`).join('');
            lucide.createIcons();
        }

        function editSop() {
            let v = document.getElementById('sop-view'), e = document.getElementById('sop-edit'), b = document.getElementById('edit-btn'), x = tasks.find(v => v.id === cur);
            if(e.classList.contains('hidden')){ 
                v.classList.add('hidden'); e.classList.remove('hidden'); e.value = x.sop; b.innerText = "完成";
            } else { 
                x.sop = e.value; v.innerHTML = marked.parse(x.sop); v.classList.remove('hidden'); e.classList.add('hidden'); b.innerText = "编辑"; saveAndSync(); 
            }
        }

        function prog(x) { return x.subs.length ? Math.round(x.subs.filter(s=>s.ok).length/x.subs.length*100) : 0; }
        function saveAndSync() { saveLocally(); push(); }
        function updateTime() { tasks.find(v => v.id === cur).time = document.getElementById('time-input').value; saveAndSync(); }

        window.onload = init;
    </script>
</body>
</html>
