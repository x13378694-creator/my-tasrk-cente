<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŒ‡æŒ¥éƒ¨ v5.1 | é˜²å´©æºƒç¨³å›ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #0D0D0D; color: #F3F4F6; height: 100vh; overflow: hidden; font-family: system-ui, sans-serif; }
        .bento-card { background: #1A1A1A; border: 1px solid #2D2D2D; transition: all 0.3s ease; }
        .progress-bar { transition: width 0.5s ease; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        /* å¼ºåˆ¶æ˜¾ç¤ºåŠ å· */
        .force-show { display: block !important; }
    </style>
</head>
<body class="flex flex-col">

    <nav class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#0D0D0D]/90 backdrop-blur-md z-50">
        <div class="flex items-center gap-3">
            <h1 class="text-xs font-black tracking-widest text-purple-500 uppercase">COMMAND_HQ</h1>
            <div id="sync-dot" class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
            <span id="status-msg" class="text-[9px] text-gray-500">ç¦»çº¿</span>
        </div>
        <div class="flex gap-2 items-center">
            <input id="sync-code-input" type="password" placeholder="è¾“å…¥å¯†é’¥" class="bg-black text-[10px] border border-gray-800 rounded px-2 py-1 w-24 outline-none text-purple-400">
            <button onclick="handleSync()" class="text-[10px] bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-500 font-bold">åŒæ­¥</button>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row p-3 gap-3 overflow-hidden">
        <section class="w-full md:w-1/3 bento-card rounded-2xl p-4 flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                <span class="text-[10px] font-bold text-gray-500 tracking-widest uppercase">ä»»åŠ¡åºåˆ—</span>
                <button onclick="addTask()" class="text-purple-500 hover:scale-125 transition-transform p-1 bg-white/5 rounded-full">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
        </section>

        <section class="flex-1 grid grid-rows-2 gap-3 overflow-hidden">
            <div class="bento-card rounded-2xl p-6 flex flex-col gap-4 overflow-hidden relative">
                <div class="flex justify-between items-start">
                    <div class="space-y-1">
                        <h2 id="title" class="text-2xl font-black italic text-white tracking-tight">å‡†å¤‡å°±ç»ª</h2>
                        <input type="time" id="time-input" onchange="updateTime()" class="bg-purple-900/20 border border-purple-500/30 text-purple-400 text-[10px] rounded px-1">
                    </div>
                    <div id="prog-text" class="text-4xl font-black text-purple-500 opacity-20">0%</div>
                </div>
                <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden">
                    <div id="bar" class="h-full bg-purple-500 shadow-[0_0_15px_#8B5CF6]" style="width:0%"></div>
                </div>
                <div id="subs" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
                <div class="flex gap-2">
                    <input id="sub-in" placeholder="è¾“å…¥æ­¥éª¤..." class="flex-1 bg-white/5 border border-gray-800 rounded-xl px-4 py-3 text-sm focus:border-purple-500 outline-none w-full">
                    <button onclick="addSub()" class="bg-purple-600 hover:bg-purple-700 px-6 rounded-xl text-sm font-bold whitespace-nowrap">æ·»åŠ </button>
                </div>
            </div>

            <div class="bento-card rounded-2xl p-6 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex gap-4">
                        <button onclick="showTab('sop')" id="tab-sop" class="text-xs font-bold pb-1 text-purple-500 border-b-2 border-purple-500">SOP æ‰‹å†Œ</button>
                        <button onclick="showTab('manual')" id="tab-manual" class="text-xs font-bold pb-1 text-gray-500">ä½¿ç”¨è¯´æ˜</button>
                    </div>
                    <button onclick="toggleEdit()" id="edit-btn" class="text-[10px] bg-white/5 px-3 py-1 rounded">ç¼–è¾‘</button>
                </div>
                <div id="view" class="flex-1 overflow-y-auto prose prose-invert prose-sm max-w-none text-gray-400"></div>
                <textarea id="edit" class="hidden flex-1 bg-black/50 text-xs p-4 rounded-xl border border-gray-800 font-mono text-purple-300 outline-none resize-none"></textarea>
            </div>
        </section>
    </main>

    <script>
        // --- Supabase é…ç½® ---
        const SUPABASE_URL = 'https://ylbwdthefpcrocmvccpy.supabase.co';
        // æ³¨æ„ï¼šè¿™æ˜¯ä½ çš„ KEYï¼Œä¸è¦æ”¹åŠ¨
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsYndkdGhlZnBjcm9jbXZjY3B5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3OTk4MDksImV4cCI6MjA4NTM3NTgwOX0.f6_5e1UpdLmZHc2aTwQJMDPTNJxb1ZQqs2OBxCklZJ4';
        
        let supabase = null;
        let tasks = [];
        let cur = null;
        let activeTab = 'sop';

        // ä½ çš„å¤‡ä»½æ•°æ®
        const backupData = [{"id":1769786819936,"title":"å†™ä¸€ç¯‡å…¬ä¼—å·ç§è‰","subtasks":[{"id":1769831964603,"text":"é€‰é¢˜","done":false}],"reminderTime":"08:00","sop":""},{"id":1769774974790,"title":"ç»ˆç‚¹ç³»ç»Ÿç½‘é¡µåˆ¶ä½œ","subtasks":[{"id":1769774994705,"text":"å»ºç«‹å¤§çº²","done":true},{"id":1769785458872,"text":"åŠ å…¥ä½¿ç”¨æ‰‹å†Œ","done":true}],"reminderTime":"08:09","sop":"# åè®® v3.0\n\n- é˜¶æ®µä¸€ï¼šå»ºç«‹å¤§çº²\n- é˜¶æ®µäºŒï¼šæ„å¿—æå«"}];

        const manualMD = `# ğŸ“˜ æ•…éšœæ’æŸ¥æ‰‹å†Œ\n\n1. **çº¢ç‚¹é—®é¢˜**ï¼šå¦‚æœè¾“å…¥å¯†é’¥ç‚¹å‡»åŒæ­¥åä»æ˜¯çº¢ç‚¹ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®å›½å¤–ç½‘ç«™ã€‚\n2. **ç¦»çº¿æ¨¡å¼**ï¼šå³ä½¿æ˜¯çº¢ç‚¹ï¼Œä½ ä¾ç„¶å¯ä»¥æ·»åŠ ä»»åŠ¡ï¼Œæ•°æ®ä¼šä¿å­˜åœ¨è¿™å°ç”µè„‘ä¸Šã€‚\n3. **åŠ å·åœ¨å“ª**ï¼šç°åœ¨åŠ å·è¢«å›ºå®šåœ¨å·¦ä¾§åˆ—è¡¨ä¸Šæ–¹ï¼Œå®ƒæ˜¯ç™½è‰²çš„åœ†å½¢æŒ‰é’®ã€‚`;

        function init() {
            lucide.createIcons();
            
            // å°è¯•åˆå§‹åŒ– Supabase
            try {
                if(typeof supabasejs !== 'undefined') {
                    supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log("Supabase åˆå§‹åŒ–æˆåŠŸ");
                } else {
                    console.error("Supabase åº“åŠ è½½å¤±è´¥");
                    document.getElementById('status-msg').innerText = "ç½‘ç»œåº“åŠ è½½å¤±è´¥";
                }
            } catch(e) {
                console.error("åˆå§‹åŒ–é”™è¯¯:", e);
            }

            // åŠ è½½æœ¬åœ°æ•°æ®
            try {
                const localData = localStorage.getItem('cmd_v51_data');
                tasks = localData ? JSON.parse(localData) : backupData;
                
                const savedCode = localStorage.getItem('user_sync_code');
                if(savedCode) {
                    document.getElementById('sync-code-input').value = savedCode;
                    // è‡ªåŠ¨å°è¯•åŒæ­¥
                    handleSync(); 
                }
            } catch(e) {
                tasks = backupData;
            }

            renderList();
            if(tasks.length > 0) sel(tasks[0].id);
        }

        // --- åŒæ­¥æ ¸å¿ƒé€»è¾‘ ---
        async function handleSync() {
            const code = document.getElementById('sync-code-input').value;
            const statusLabel = document.getElementById('status-msg');
            
            if(!code) {
                alert("è¯·è¾“å…¥åŒæ­¥å¯†é’¥ï¼ˆä»»æ„å•è¯ï¼Œå¦‚ 'mykey'ï¼‰");
                return;
            }
            
            localStorage.setItem('user_sync_code', code);
            statusLabel.innerText = "åŒæ­¥ä¸­...";
            
            if(!supabase) {
                alert("æ— æ³•è¿æ¥äº‘ç«¯æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
                statusLabel.innerText = "è¿æ¥å¤±è´¥";
                return;
            }

            try {
                // 1. å…ˆæ¨é€åˆ°äº‘ç«¯
                const { error: pushError } = await supabase.from('tasks_sync').upsert({ id: code, sync_code: code, data: tasks });
                if(pushError) throw pushError;

                // 2. å†ä»äº‘ç«¯æ‹‰å–ï¼ˆä»¥é˜²æœ‰æ–°æ•°æ®ï¼‰
                const { data, error: pullError } = await supabase.from('tasks_sync').select('data').eq('sync_code', code).maybeSingle();
                if(pullError) throw pullError;

                if(data && data.data) {
                    tasks = data.data; // æ›´æ–°æœ¬åœ°æ•°æ®
                    saveLocal();
                    renderList();
                    if(cur) sel(cur);
                }
                
                // æˆåŠŸï¼
                mark(true);
                statusLabel.innerText = "å·²åŒæ­¥";
                
            } catch(err) {
                console.error("åŒæ­¥å¤±è´¥:", err);
                mark(false);
                statusLabel.innerText = "åŒæ­¥å‡ºé”™";
                // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿè¦ä¿è¯æœ¬åœ°èƒ½ç”¨ï¼Œä¸æŠ¥é”™
            }
        }

        function mark(ok) { 
            document.getElementById('sync-dot').className = `w-2.5 h-2.5 rounded-full ${ok?'bg-green-500 shadow-[0_0_10px_#22C55E]':'bg-red-500'}`; 
        }

        function saveLocal() { 
            localStorage.setItem('cmd_v51_data', JSON.stringify(tasks)); 
        }

        // --- ä»»åŠ¡æ“ä½œ ---
        function addTask() {
            let t = prompt("è¾“å…¥æ–°ä»»åŠ¡åç§°:");
            if(!t) return;
            tasks.unshift({id:Date.now(), title:t, subtasks:[], reminderTime:"", sop:"", done:false});
            saveLocal(); // å…ˆå­˜æœ¬åœ°
            renderList(); 
            sel(tasks[0].id);
            handleSync(); // å°è¯•åå°åŒæ­¥
        }

        function renderList() {
            const list = document.getElementById('list');
            list.innerHTML = tasks.map(x => `
                <div onclick="sel(${x.id})" class="p-3 rounded-xl cursor-pointer border transition-all ${cur===x.id?'border-purple-500 bg-purple-500/10':'border-gray-800 hover:border-gray-700'}">
                    <div class="flex justify-between text-[10px] mb-2 font-bold uppercase"><span>${x.title}</span><span class="text-purple-500">${prog(x)}%</span></div>
                    <div class="w-full h-[2px] bg-gray-800 rounded-full overflow-hidden"><div class="bg-purple-500 h-full" style="width:${prog(x)}%"></div></div>
                </div>`).join('');
        }

        function sel(id) {
            cur = id; 
            let x = tasks.find(v => v.id === id);
            if(!x) return;
            document.getElementById('title').innerText = x.title;
            document.getElementById('time-input').value = x.reminderTime || "";
            renderSubs(); showTab(activeTab); renderList();
        }

        function addSub() {
            let i = document.getElementById('sub-in');
            if(!i.value || !cur) return;
            tasks.find(x => x.id === cur).subtasks.push({id:Date.now(), text:i.value, done:false});
            i.value = ""; 
            saveLocal(); renderSubs(); handleSync();
        }

        function toggle(sid) {
            let x = tasks.find(v => v.id === cur);
            let s = x.subtasks.find(v => v.id === sid);
            s.done = !s.done; 
            saveLocal(); renderSubs(); renderList(); handleSync();
        }

        function renderSubs() {
            let x = tasks.find(v => v.id === cur);
            if(!x) return;
            document.getElementById('bar').style.width = prog(x) + '%';
            document.getElementById('prog-text').innerText = prog(x) + '%';
            document.getElementById('subs').innerHTML = x.subtasks.map(s => `
                <div class="flex items-center gap-3 bg-white/[0.03] p-3 rounded-xl hover:bg-white/[0.06]"><input type="checkbox" ${s.done?'checked':''} onchange="toggle(${s.id})"><span class="text-sm ${s.done?'line-through text-gray-600':''}">${s.text}</span></div>`).join('');
        }

        function showTab(type) {
            activeTab = type;
            const x = tasks.find(v => v.id === cur);
            const view = document.getElementById('view');
            document.getElementById('tab-sop').className = `text-xs font-bold pb-1 ${type==='sop'?'text-purple-500 border-b-2 border-purple-500':'text-gray-500'}`;
            document.getElementById('tab-manual').className = `text-xs font-bold pb-1 ${type==='manual'?'text-purple-500 border-b-2 border-purple-500':'text-gray-500'}`;
            view.innerHTML = marked.parse(type==='manual'?manualMD:(x?(x.sop||"_æš‚æ—  SOP_"):"æœªé€‰æ‹©ä»»åŠ¡"));
        }

        function toggleEdit() {
            let v = document.getElementById('view'), e = document.getElementById('edit'), b = document.getElementById('edit-btn'), x = tasks.find(v => v.id === cur);
            if(!x) return;
            if(e.classList.contains('hidden')){ v.classList.add('hidden'); e.classList.remove('hidden'); b.innerText="ä¿å­˜"; e.value=x.sop; }
            else { x.sop = e.value; v.innerHTML = marked.parse(e.value); v.classList.remove('hidden'); e.classList.add('hidden'); b.innerText="ç¼–è¾‘"; saveLocal(); handleSync(); }
        }

        function prog(x) { return x.subtasks && x.subtasks.length ? Math.round(x.subtasks.filter(s=>s.done).length/x.subtasks.length*100) : 0; }
        function updateTime() { tasks.find(v => v.id === cur).reminderTime = document.getElementById('time-input').value; saveLocal(); handleSync(); }
        
        // å¯åŠ¨ï¼
        window.onload = init;
    </script>
</body>
</html>
